<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>NanoNaut - THE game</title>
        
        <!-- Use debug variant of phaser for now. -->
        <script src="//cdn.jsdelivr.net/phaser/2.6.2/phaser.js"></script>
    </head>
    
    <body id="game">
        <script type="text/javascript">
            var game = new Phaser.Game(1280, 720, Phaser.AUTO, "game", {preload: preload, create: create, update: update, render: render});
            
            // REFACTOR: Pull out State Object
            var player;
            var background;
            var input;
            var bullets;
            var bulletTime = 0;
            var asteroidLarge;
            var asteroidMedium;
            var asteroidSmall;

            function preload() {
                game.load.image("SHIP", "assets/SpaceShip.png");
                game.load.image("BULLET", "assets/Bullet.png");
                game.load.image("ASTEROID_1", "assets/Asteroid_01.png");
                game.load.image("ASTEROID_2", "assets/Asteroid_02.png");
                game.load.image("ASTEROID_3", "assets/Asteroid_03.png");
                game.load.image("BACKGROUND", "assets/background.png");
            }
            
            function create() {
                game.renderer.clearBeforeRender = false;
                game.renderer.roundPixels = true;

                //  We need arcade physics
                game.physics.startSystem(Phaser.Physics.ARCADE);
                
                background = game.add.sprite(1280,720,'BACKGROUND');
                
                bullets = game.add.group();
                bullets.enableBody = true;
                bullets.physicsBodyType = Phaser.Physics.ARCADE;
                bullets.createMultiple(40,'BULLET');
                bullets.setAll('anchor.x',0.5);
                bullets.setAll('anchor.y',0.5);

                player = game.add.sprite(300, 300, 'SHIP');
                player.anchor.set(0.5);
                game.physics.enable(player, Phaser.Physics.ARCADE);
                player.body.drag.set(100);
                player.body.maxVelocity.set(200);

                asteroidLarge = game.add.group();
                asteroidLarge.enableBody = true;
                asteroidLarge.physicsBodyType = Phaser.Physics.ARCADE;
                asteroidLarge.createMultiple(10,'ASTEROID_1');
                asteroidLarge.setAll('anchor.x',0.5);
                asteroidLarge.setAll('anchor.y',0.5);
                asteroidLarge.scale.set(2,2);

                asteroidMedium = game.add.group();
                asteroidMedium.enableBody = true;
                asteroidMedium.physicsBodyType = Phaser.Physics.ARCADE;
                asteroidMedium.createMultiple(30,'ASTEROID_2');
                asteroidMedium.setAll('anchor.x',0.5);
                asteroidMedium.setAll('anchor.y',0.5);

                asteroidSmall = game.add.group();
                asteroidSmall.enableBody = true;
                asteroidSmall.physicsBodyType = Phaser.Physics.ARCADE;
                asteroidSmall.createMultiple(90,'ASTEROID_3');
                asteroidSmall.setAll('anchorx',0.5);
                asteroidSmall.setAll('anchor.y',0.5);
                asteroidSmall.scale.set(0.5,0.5);

                input = game.input.keyboard.createCursorKeys();
                game.input.keyboard.addKeyCapture([Phaser.Keyboard.SPACEBAR]);
            }
                
            function update() {
            	spawnasteroids();

                if (input.up.isDown) {
                    game.physics.arcade.accelerationFromRotation(player.rotation, 200, player.body.acceleration);
                } else {
                    player.body.acceleration.set(0);
                }
                
                if (input.left.isDown) {
                    player.body.angularVelocity = -300;
                } else if (input.right.isDown) {
                    player.body.angularVelocity = 300;
                } else {
                    player.body.angularVelocity = 0;
                }

                if(game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)) {
                	fireBullet();
                }
                
                game.physics.arcade.overlapt(bullets, asteroidLarge, degradeLarge);
                game.physics.arcade.overlapt(bullets, asteroidMedium, degradeMedium);
                game.physics.arcade.overlapt(bullets, asteroidSmall, degradeSmall);

                screenWrap(player);
                bullets.forEachExists(screenWrap, this);
                asteroidLarge.forEachExists(screenWrap, this);
                asteroidMedium.forEachExists(screenWrap, this);
                asteroidSmall.forEachExists(screenWrap, this);
            }
            
            function render() {
            
            }
            
            // OTHER FUNCTIONS
            function screenWrap (sprite) {
                if (sprite.x < 0) {
                    sprite.x = game.width;
                } else if (sprite.x > game.width) {
                    sprite.x = 0;
                }

                if (sprite.y < 0) {
                    sprite.y = game.height;
                } else if (sprite.y > game.height) {
                    sprite.y = 0;
                }
            }

            function fireBullet() { 
            	if(game.time.now > bulletTime){
            		var bullet = bullets.getFirstExists(false);

            		if(bullet){
            			bullet.reset(player.body.x + 8, player.body.y + 8);
            			bullet.lifespan = 2000;
            			bullet.rotation = player.rotation;
            			game.physics.arcade.velocityFromRotation(player.rotation, 400, bullet.body.velocity);
            			bulletTime = game.time.now + 50;
            		}
            	}
            }

           function spawnasteroids(){
           		if (Math.random() <= .10) { // Spawn an asteroid?
           			var position;
           			if (Math.random() <= .5) { // Spawn to left or right?
           				var x;
           				if (Math.random() <= .5) { // Spawn to the left.
           					x = -100;
           				} else { // Spawn to the right.
           					x = game.width + 100;
           				}

           				var y = Math.random() * game.height;
           				position = {x: x, y: y};
           			} else { // Spawn to top or bottom.
           				var y;
           				if (Math.random() <= .5) { // Spawn to top or bottom?
           					y = -100;
           				} else { // Spawn to bottom.
           					y = game.height + 100;
           				}

           				var x = Math.random() * game.width;
           				position = {x: x, y: y};
           			}

           			var angle = Math.random() * 360;
           			var speed = 50;

           			spawnAsteroid(asteroidLarge, position, angle, speed);
           		}
           	}
           	function spawnAsteroid(group, position, angle, speed) {
           		var asteroid = group.getFirstExists(false);

           		if (asteroid) {
           			asteroid.reset(position.x, position.y);
           			asteroid.angle = angle;
           			game.physics.arcade.velocityFromRotation(asteroid.rotation, speed, asteroid.body.velocity);
           		}
           	}

            function degradeLarge(bullet, asteroid) {
                destroyAsteroid(bullet, asteroid);
                splitAsteroid(asteroid, asteroidMedium);
            }
            function degradeMedium(bullet, asteroid) {
                destroyAsteroid(bullet, asteroid);
                splitAsteroid(asteroid, asteroidSmall);
            }
            function degradeSmall(bullet, asteroid) {
                destroyAsteroid(bullet, asteroid);
            }
            function splitAsteroid(asteroid, group) {
                var angle1 = asteroid.angle + 90;
                var angle2 = asteroid.angle + 180;
                var angle3 = asteroid.angle + 270;
                var position = {x: asteroid.body.x, y: asteroid.body.y};
                var velocity = asteroid.body.velocity * 1.5;
                spawnAsteroid(group, position, angle1, velocity);
                spawnAsteroid(group, position, angle2, velocity);
                spawnAsteroid(group, position, angle3, velocity);
            }
            function destoryAsteroid(bullet, asteroid) {
                bullet.kill();
                asteroid.kill();
            }
        </script>
    </body>
</html>